name: Nginx Builder (ARM64)

on:
  workflow_run:
    workflows: ["Nginx Builder"]
    types:
      - completed
  workflow_dispatch:

permissions:
  contents: write # Needed for creating releases

jobs:
  build-arm:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: linux/arm64
            suffix: arm64
    outputs:
      version: ${{ steps.nginx_version.outputs.version }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Resolve Nginx Version (Mainline)
        id: nginx_version
        run: |
          # Resolve latest Mainline version (usually the latest tag)
          TAG=$(git ls-remote --tags --refs --sort='v:refname' https://github.com/nginx/nginx.git | grep -oE "release-[0-9.]+" | tail -n1)
          VERSION=${TAG#release-}
          echo "Found Nginx Version: $VERSION"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: Build and Export
        run: |
          docker buildx build \
            --platform ${{ matrix.platform }} \
            --build-arg NGINX_VERSION=${{ env.VERSION }} \
            --output type=local,dest=./output \
            .
      
      - name: Rename Artifact
        run: |
          mv ./output/nginx-custom.tar.gz ./output/nginx-mainline-mk-${{ env.VERSION }}-${{ github.event.workflow_run.run_number }}-linux-${{ matrix.suffix }}.tar.gz
          
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: nginx-mainline-mk-${{ env.VERSION }}-${{ github.event.workflow_run.run_number }}-${{ matrix.suffix }}
          path: ./output/*.tar.gz
          
      - name: Generate Checksums
        if: github.ref == 'refs/heads/master'
        run: |
          cd output
          sha256sum *.tar.gz > sha256sums-${{ matrix.suffix }}.txt
          cd ..
          
      - name: Upload Checksums
        if: github.ref == 'refs/heads/master'
        uses: actions/upload-artifact@v4
        with:
          name: sha256sums-${{ matrix.suffix }}
          path: ./output/sha256sums-*.txt

  release-arm:
    needs: build-arm
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master'
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          
      - name: Resolve Nginx Version (Again for Release)
        id: nginx_version_release
        run: |
          TAG=$(git ls-remote --tags --refs --sort='v:refname' https://github.com/nginx/nginx.git | grep -oE "release-[0-9.]+" | tail -n1)
          VERSION=${TAG#release-}
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          
      - name: Prepare Release Files
        run: |
          mkdir release_files
          find artifacts -name "*.tar.gz" -exec cp {} release_files/ \;
          find artifacts -name "sha256sums-*.txt" -exec cp {} release_files/ \;
          ls -l release_files/
          
      - name: Publish Release (Append ARM64)
        uses: softprops/action-gh-release@v1
        with:
          tag_name: nginx-mainline-mk/${{ env.VERSION }}-${{ github.event.workflow_run.run_number }}
          name: Nginx Mainline MK ${{ env.VERSION }} Build ${{ github.event.workflow_run.run_number }}
          files: release_files/*
          prerelease: false
          fail_on_unmatched_files: true
          # append_body: true # Optional: append to existing release body if needed, but not strictly required for asset upload
          # action-gh-release defaults to updating existing releases
