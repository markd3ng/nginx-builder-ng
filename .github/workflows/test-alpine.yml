name: Alpine Integration Test
on:
  workflow_call:
    inputs:
      version:
        required: true
        type: string
      issue_number:
        required: false
        type: string
        default: ""

jobs:
  test-alpine-binary:
    runs-on: ubuntu-latest
    container:
      image: alpine:3.19
    permissions:
      contents: read
      issues: write
      pull-requests: write
    steps:
      - name: Install Runtime Dependencies
        run: |
          apk add --no-cache \
            curl \
            libmaxminddb \
            libxml2 \
            libxslt \
            gd \
            linux-pam \
            zstd-libs \
            pcre2 \
            openssl \
            perl \
            tzdata \
            luajit
          
          # Create www-data user and group for nginx
          addgroup -g 82 -S www-data
          adduser -u 82 -D -S -G www-data www-data

      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: nginx-mainline-mk-${{ inputs.version }}-alpine-amd64
          path: ./

      - name: Extract and Install
        id: install
        run: |
          # Êü•ÊâæÊñá‰ª∂Ôºå‰ª•Èò≤ÁâàÊú¨Âè∑ÂåπÈÖçÊúâÁªÜÂæÆÂ∑ÆÂºÇÔºàËôΩÁÑ∂ÈÄöÂ∏∏‰∏ç‰ºöÔºâ
          TAR_FILE=$(find . -name "nginx-mainline-mk-*-alpine-amd64.tar.gz" | head -n 1)
          
          if [ -z "$TAR_FILE" ]; then
             echo "Error: Artifact file not found!"
             ls -R
             echo "status=failure" >> $GITHUB_OUTPUT
             exit 1
          fi

          echo "Installing $TAR_FILE..."
          if tar -xzf "$TAR_FILE" -C /; then
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Verify Version info
        id: version_check
        run: |
          if OUTPUT=$(/usr/sbin/nginx -V 2>&1); then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "$OUTPUT" > nginx_info.txt
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "Failed to get version info" > nginx_info.txt
          fi

      - name: Start and Verify Server Header
        id: server_header
        run: |
          mkdir -p /var/log/nginx /var/cache/nginx
          /usr/sbin/nginx
          sleep 2
          
          RESPONSE=$(curl -I -s http://localhost || echo "Curl failed")
          echo "$RESPONSE"
          
          if echo "$RESPONSE" | grep -q "Server: nginx-mainline-mk"; then
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
          fi

      - name: Verify Compiled Modules
        id: modules_check
        run: |
          # Find the file wherever it is (root or output/ subdir)
          EXPECTED_FILE=$(find . -name "expected_modules.txt" | head -n 1)
          
          if [ -z "$EXPECTED_FILE" ]; then
             echo "‚ö†Ô∏è No expected_modules.txt found in artifact."
             ls -R
             echo "status=skipped" >> $GITHUB_OUTPUT
             echo "Skipped (File not found)" > modules_report.txt
             exit 0
          fi
          
          echo "Checking modules against: $EXPECTED_FILE"
          FAILURES=0
          
          # Capture nginx -V output once
          NGINX_V=$(/usr/sbin/nginx -V 2>&1)
          MODULES_REPORT=""
          
          while read -r MODULE; do
            # Skip comments and empty lines
            case "$MODULE" in
              \#*) continue ;;
              "") continue ;;
            esac
            
            # Clean module name just in case
            MODULE=$(echo "$MODULE" | tr -d '\r')
            
            if echo "$NGINX_V" | grep -q "$MODULE"; then
              echo "‚úÖ Module $MODULE found"
              MODULES_REPORT="${MODULES_REPORT}- ‚úÖ $MODULE\n"
            else
              echo "‚ùå Module $MODULE MISSING"
              MODULES_REPORT="${MODULES_REPORT}- ‚ùå $MODULE MISSING\n"
              FAILURES=$((FAILURES+1))
            fi
          done < "$EXPECTED_FILE"
          
          printf "%b" "$MODULES_REPORT" > modules_report.txt
          
          if [ "$FAILURES" -gt 0 ]; then
             echo "Found $FAILURES missing modules!"
             echo "status=failure" >> $GITHUB_OUTPUT
             exit 1 
          else
             echo "status=success" >> $GITHUB_OUTPUT
          fi

      - name: Generate Report
        if: always()
        run: |
          # Êî∂ÈõÜÁªìÊûú
          if [ "${{ steps.install.outcome }}" = "success" ]; then
            INSTALL_STATUS="‚úÖ PASS"
          else
            INSTALL_STATUS="‚ùå FAIL"
          fi
          
          if [ "${{ steps.version_check.outcome }}" = "success" ]; then
            VERSION_STATUS="‚úÖ PASS"
          else
            VERSION_STATUS="‚ùå FAIL"
          fi
          
          if [ "${{ steps.server_header.outcome }}" = "success" ]; then
            HEADER_STATUS="‚úÖ PASS"
          else
            HEADER_STATUS="‚ùå FAIL"
          fi
          
          if [ "${{ steps.modules_check.outcome }}" = "success" ]; then
            MODULES_STATUS="‚úÖ PASS"
          elif [ "${{ steps.modules_check.outcome }}" = "skipped" ]; then
            MODULES_STATUS="‚ö†Ô∏è SKIP"
          else
            MODULES_STATUS="‚ùå FAIL"
          fi
          
          if [ "${{ steps.install.outcome }}" = "success" ] && \
             [ "${{ steps.version_check.outcome }}" = "success" ] && \
             [ "${{ steps.server_header.outcome }}" = "success" ] && \
             ( [ "${{ steps.modules_check.outcome }}" = "success" ] || [ "${{ steps.modules_check.outcome }}" = "skipped" ] ); then
             STATUS="‚úÖ ÈÄöËøá"
             EMOJI="üéâ"
          else
             STATUS="‚ùå Â§±Ë¥•"
             EMOJI="‚ö†Ô∏è"
          fi
          
          # ÁîüÊàê markdown
          cat << EOF > test_report.md
          # $EMOJI Nginx Alpine Êú¨Âú∞ÊµãËØïÊä•Âëä
          
          ## üìã ‰ø°ÊÅØ
          | È°πÁõÆ | ÂÄº |
          |:---|:---|
          | ÁâàÊú¨ | \`${{ inputs.version }}\` |
          | Âπ≥Âè∞ | Alpine Linux 3.19 (musl libc) |
          | ËøêË°åÁºñÂè∑ | [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |
          | Ëß¶ÂèëËÄÖ | @${{ github.actor }} |
          
          **ÊÄªËØÑ: $STATUS**
          
          ## üìä ÊµãËØïÁªìÊûú
          | ÊµãËØïÈ°π | ÁªìÊûú |
          |:---|:---|
          | ÂÆâË£Ö‰∏éËß£Âéã | $INSTALL_STATUS |
          | ÁâàÊú¨Ê£ÄÊü• (nginx -V) | $VERSION_STATUS |
          | Server Â§¥È™åËØÅ | $HEADER_STATUS |
          | ÂÖ≥ÈîÆÊ®°ÂùóÊ†°È™å | $MODULES_STATUS |
          
          ## üîß ËØ¶ÁªÜ‰ø°ÊÅØ
          ### Ê®°ÂùóÊ£ÄÊü•ËØ¶ÊÉÖ
          \`\`\`
          $(cat modules_report.txt 2>/dev/null || echo "N/A")
          \`\`\`

          ### Nginx Info
          \`\`\`
          $(cat nginx_info.txt 2>/dev/null || echo "N/A")
          \`\`\`
          
          ---
          *Report generated by GitHub Actions*
          EOF

      - name: Write Job Summary
        if: always()
        run: cat test_report.md >> $GITHUB_STEP_SUMMARY

      - name: Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-report-alpine
          path: |
             test_report.md
             nginx_info.txt
             modules_report.txt

      - name: Comment on Issue
        if: always() && inputs.issue_number != ''
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('test_report.md', 'utf8');
            const issueNumber = '${{ inputs.issue_number }}';
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: report
            });
