name: Nginx Builder

on:
  push:
    branches: [ "master", "feat/**" ]
    paths-ignore:
      - '**.md'
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 1' # Weekly updates

permissions:
  contents: write # Needed for creating releases
  issues: write   # Needed for test reporting
  pull-requests: write # Needed for test reporting on PRs

env:
  TEST_REPORT_ISSUE: "1"

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: linux/amd64
            suffix: amd64
          - platform: linux/arm64
            suffix: arm64
    outputs:
      version: ${{ steps.nginx_version.outputs.version }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Resolve Nginx Version (Env)
        id: nginx_version
        run: |
          # Load pinned versions
          source versions.env
          echo "Using Pinned Nginx Version: $NGINX_VERSION"
          echo "VERSION=$NGINX_VERSION" >> $GITHUB_ENV
          echo "version=$NGINX_VERSION" >> $GITHUB_OUTPUT
      
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: Build and Export
        run: |
          docker buildx build \
            --platform ${{ matrix.platform }} \
            --build-arg NGINX_VERSION=${{ env.VERSION }} \
            --output type=local,dest=./output \
            .
      
      - name: Rename Artifact
        run: |
          mv ./output/nginx-custom.tar.gz ./output/nginx-mainline-mk-${{ env.VERSION }}-${{ github.run_number }}-linux-${{ matrix.suffix }}.tar.gz
          
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: nginx-mainline-mk-${{ env.VERSION }}-${{ github.run_number }}-${{ matrix.suffix }}
          path: |
            ./output/*.tar.gz
            ./output/*.tar.gz
            ./output/expected_modules.txt
            ./output/build_summary.json

      - name: Generate Build Report
        if: always()
        id: report
        run: |
          echo "Processing Build Reports..."
          
          # Initialize report
          echo "# ðŸ—ï¸ Nginx Build Report (${{ matrix.suffix }})" > report.md
          
          if [ -f ./output/build_summary.json ]; then
            cat ./output/build_summary.json | jq -r '
              "## ðŸ“Š Build Metrics
              | Metric | Value |
              | :--- | :--- |
              | **Nginx Version** | \(.nginx_version) |
              | **OpenSSL Version** | \(.openssl_version) |
              | **Size (Before Strip)** | \((.size_before_strip | tonumber / 1024 / 1024 | .*100 | round / 100)) MB |
              | **Size (After Strip)** | \((.size_after_strip | tonumber / 1024 / 1024 | .*100 | round / 100)) MB |
              | **Reduction** | \(((.size_before_strip | tonumber) - (.size_after_strip | tonumber)) / 1024 / 1024 | .*100 | round / 100) MB |
              "
            ' >> report.md
          else
             echo "âš ï¸ No build summary found." >> report.md
          fi
          
          cat report.md >> $GITHUB_STEP_SUMMARY

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: thollander/actions-comment-pull-request@v2
        with:
          filePath: report.md
          comment_tag: build_report_${{ matrix.suffix }}
          
      - name: Generate Checksums
        if: github.ref == 'refs/heads/master'
        run: |
          cd output
          sha256sum *.tar.gz > sha256sums-${{ matrix.suffix }}.txt
          cd ..
          
      - name: Upload Checksums
        if: github.ref == 'refs/heads/master'
        uses: actions/upload-artifact@v4
        with:
          name: sha256sums-${{ matrix.suffix }}
          path: ./output/sha256sums-*.txt

  test:
    needs: build
    if: github.ref == 'refs/heads/master'
    uses: ./.github/workflows/test.yml
    with:
      version: ${{ needs.build.outputs.version }}-${{ github.run_number }}
      issue_number: "1"
    secrets: inherit

  release:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master'
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          
      - name: Resolve Nginx Version (Again for Release)
        id: nginx_version_release
        run: |
          source versions.env
          echo "VERSION=$NGINX_VERSION" >> $GITHUB_ENV
          
      - name: Prepare Release Files
        run: |
          mkdir release_files
          find artifacts -name "*.tar.gz" -exec cp {} release_files/ \;
          find artifacts -name "sha256sums-*.txt" -exec cp {} release_files/ \;
          # Copy expected_modules.txt (take the first one found, they should be identical)
          find artifacts -name "expected_modules.txt" | head -n 1 | xargs -I {} cp {} release_files/
          
          # No merging of checksums anymore, we keep separate files for amd64 and arm64
          ls -l release_files/
          
      - name: Publish Release (Dynamic Tag)
        uses: softprops/action-gh-release@v1
        with:
          tag_name: nginx-mainline-mk/${{ env.VERSION }}-${{ github.run_number }}
          name: Nginx Mainline MK ${{ env.VERSION }} Build ${{ github.run_number }}
          files: release_files/*
          prerelease: false
          fail_on_unmatched_files: true
