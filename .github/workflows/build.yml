name: Nginx Builder

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 1' # Weekly updates

permissions:
  contents: write # Needed for creating releases
  issues: write   # Needed for test reporting
  pull-requests: write # Needed for test reporting on PRs

env:
  TEST_REPORT_ISSUE: "1"

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: linux/amd64
            suffix: amd64
          - platform: linux/arm64
            suffix: arm64
    outputs:
      version: ${{ steps.nginx_version.outputs.version }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Resolve Nginx Version (Mainline)
        id: nginx_version
        run: |
          # Resolve latest Mainline version (usually the latest tag)
          TAG=$(git ls-remote --tags --refs --sort='v:refname' https://github.com/nginx/nginx.git | grep -oE "release-[0-9.]+" | tail -n1)
          VERSION=${TAG#release-}
          echo "Found Nginx Version: $VERSION"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: Build and Export
        run: |
          docker buildx build \
            --platform ${{ matrix.platform }} \
            --build-arg NGINX_VERSION=${{ env.VERSION }} \
            --output type=local,dest=./output \
            .
      
      - name: Rename Artifact
        run: |
          mv ./output/nginx-custom.tar.gz ./output/nginx-mainline-mk-${{ env.VERSION }}-${{ github.run_number }}-linux-${{ matrix.suffix }}.tar.gz
          
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: nginx-mainline-mk-${{ env.VERSION }}-${{ github.run_number }}-${{ matrix.suffix }}
          path: |
            ./output/*.tar.gz
            ./output/expected_modules.txt
          
      - name: Generate Checksums
        if: github.ref == 'refs/heads/master'
        run: |
          cd output
          sha256sum *.tar.gz > sha256sums-${{ matrix.suffix }}.txt
          cd ..
          
      - name: Upload Checksums
        if: github.ref == 'refs/heads/master'
        uses: actions/upload-artifact@v4
        with:
          name: sha256sums-${{ matrix.suffix }}
          path: ./output/sha256sums-*.txt

  test:
    needs: build
    if: github.ref == 'refs/heads/master'
    uses: ./.github/workflows/test.yml
    with:
      version: ${{ needs.build.outputs.version }}-${{ github.run_number }}
      issue_number: "1"
    secrets: inherit

  release:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master'
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          
      - name: Resolve Nginx Version (Again for Release)
        id: nginx_version_release
        run: |
          TAG=$(git ls-remote --tags --refs --sort='v:refname' https://github.com/nginx/nginx.git | grep -oE "release-[0-9.]+" | tail -n1)
          VERSION=${TAG#release-}
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          
      - name: Prepare Release Files
        run: |
          mkdir release_files
          find artifacts -name "*.tar.gz" -exec cp {} release_files/ \;
          find artifacts -name "sha256sums-*.txt" -exec cp {} release_files/ \;
          # Copy expected_modules.txt (take the first one found, they should be identical)
          find artifacts -name "expected_modules.txt" | head -n 1 | xargs -I {} cp {} release_files/
          
          # No merging of checksums anymore, we keep separate files for amd64 and arm64
          ls -l release_files/
          
      - name: Publish Release (Dynamic Tag)
        uses: softprops/action-gh-release@v1
        with:
          tag_name: nginx-mainline-mk/${{ env.VERSION }}-${{ github.run_number }}
          name: Nginx Mainline MK ${{ env.VERSION }} Build ${{ github.run_number }}
          files: release_files/*
          prerelease: false
          fail_on_unmatched_files: true
